![image-20210501112228690](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501112228690.png)

自动回复：

![image-20210501125726108](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501125726108.png)

![image-20210501125812312](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501125812312.png)

![image-20210501133314330](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501133314330.png)

自定义菜单

![image-20210501133550693](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501133550693.png)

![image-20210501133709754](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501133709754.png)

  

新浪云sae创建nodejs容器应用 通过git把服务端代码push 到新浪云



![image-20210501214042929](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501214042929.png)

# 3.js-sdk

## 3-1 js-sdk鉴权流程

![image-20210501214913630](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501214913630.png)

![image-20210501215458429](C:\Users\happy\AppData\Roaming\Typora\typora-user-images\image-20210501215458429.png)

### 步骤一：绑定域名

* 1.微信公众平台进入“**公众设置**”的“**功能设置**”里填写“**js接口安全域名**”。

> 需要实现下载一个MP_verify_CkkLkOrI8NqpLutd.txt文件，放在我们自己填写的域名的静态资源文件夹下去 
> 保证我们可以通过域名路径+MP_verify_CkkLkOrI8NqpLutd.txt的方式可以访问到该文件，已做验证
> 例如：我们想要配置happister.saelinzi.com 域名
> 则我们要保证通过happister.saelinzi.com/MP_verify_CkkLkOrI8NqpLutd.txt 可以访问到服务器上的这个文件

* 2.**IP白名单配置**

> 微信公众平台进入“安全中心”的“IP白名单”里填写，跟js-sdk鉴权相关的所有ip
> 新浪云相关ip的位置：文档中心----入口与出口ip----外网访问出口 ip 列表

### 步骤二：引入JS文件

> 在需要调用js接口的页面引入如下js文件，（支持https）：http://res.wx.qq.com/open/js/jweixin-1.4.0.js

### 步骤三：通过config接口注入权限验证配置

> 所有需要使用js-sdk的页面必须先注入配置信息，否则将无法调用
> 配置项代码如下：

```
wx.config({
  debug: true, // 开启调试模式，调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
  appId: '自己公众号的APPID', // 必填，公众号的唯一标识
  timestamp: '自己在服务端写一个方法函数生成', // 必填，生成签名的时间戳
  nonceStr: '自己在服务端写一个方法函数生成', // 必填，生成,生成签名的随机串
  signature: '需要跟微信服务器对接', // 必填，签名
  jsApiList: [
    'chooseImage',
    'openLocation',
    'getLocation'
  ] // 必填，需要使用的js接口列表
})
```



## 3-2 公众号js安全域名设置

* 微信公众平台后台→公众号设置→功能设置→js接口安全域名  

## 3-3 公众号服务器接入

* 微信公众平台后台→基本配置→服务器配置

  * 第一步，填写服务器配置

    * URL
    * Token
    * EncodingAESKey
    * 消息加解密方式

  * 第二步，验证消息的确来自微信服务器

    * 开发者提交信息后，微信服务器发送GET请求到填写的服务器地址URL上，GET请求携带参数如下表所示：

      * | 参数      | 描述                                                         |
        | --------- | ------------------------------------------------------------ |
        | signature | 微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。 |
        | timestamp | 时间戳                                                       |
        | nonce     | 随机数                                                       |
        | echostr   | 随机字符串                                                   |

      * ```shell
        nodejs验证代码实现:
        router.get('/auth', function(req, res) {
          let { signature, timestamp, nonce, echostr } = req.query;
          let token = 'testweixin';
          let array = [timestamp, nonce, token];
          array.sort(); // 字典排序
          let str = array.join('');
          let resultStr = sha1(str); // 对字符串进行sha1加密,npm i sha1
          if(resultStr == signature){
            res.set('Content-type', 'text/plain')
            res.send(echostr);
          }else{
            res.send('Error!!!!!')
          }
        })
        ```

      * 

  * 第三步，依据接口文档实现业务逻辑

## 3-4 获取鉴权接口所需的jsapi_ticket

![image-20210524152734397](笔记.assets/image-20210524152734397.png)

* 微信开放文档→微信网页开发→JS-SDK说明文档→1.1.3 步骤三:通过config接口注入权限验证配置→附录1→jsapi_ticket→access_token→https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html→获取access_token接口: https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
* 通过这个接口获取jsapi_ticket:https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&type=jsapi

## 3-5 获取鉴权接口所需的signature签名信息

```shell
# config/index.js文件
module.exports = {
  appid: '***',
  secret: '***'
}
```

```shell
# utils/sign.js文件
let {appid, secret} = require('../config')
let axios = require('axios')
let sha1 = require('sha1') # npm i sha1

async function getTicket() { // 获取ticket的方法函数
  let tokenUrl = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appid}&secret=${secret}`
  let token_data = await axios.get(tokenUrl)
  console.log('token_data', token_data.data);
  let access_token = token_data.data.access_token // 得到access_token

  let ticketUrl = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${access_token}&type=jsapi`
  let ticket_data = await axios.get(ticketUrl) // 得到jsapi_ticket
  console.log('ticket', ticket_data.data);
  return ticket_data.data.ticket
}

let createNonceStr = function(){
  return Math.random().toString(36).substr(2,15)
}

let createTimestamp =  function(){
  return parseInt(new Date().getTime() / 1000) + ''
}

let sign = async function(url) {
  
  let jsapi_ticket = await getTicket()
  
  let obj = {
    jsapi_ticket,
    noncestr: createNonceStr(),
    timestamp: createTimestamp(),
    url
  }

  /* 
  1.参与签名的字段包括noncestr（随机字符串）, 有效的jsapi_ticket, timestamp（时间戳）, url（当前网页的URL，不包含#及其后面部分） 。
  2.对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，
  3.使用URL键值对的格式（即key1=value1&key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。
  4.对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。 
  */
  let str = row(obj)
  let signature = sha1(str) // 生成签名
  obj.signature = signature
  return obj
}
let row = function(obj) {
  let keys =  Object.keys(obj)
  keys = keys.sort() // 字典排序
  let newObj = {}
  keys.forEach((key)=>{
    newObj[key] = obj[key]
  })
  let string = ''
  for(let k in newObj){
    string += '&' + k +'=' + newObj[k]
  }
  string = string.substr(1)
  return string
}

module.exports = sign

```

```shell
# routes/index.js路由文件
let sign = require('../utils/sign')

router.get('/jsapi', async function(req, res) {
  let url = decodeURIComponent(req.query.url)
  let conf = await sign(url)
  console.log('conf',conf);
  res.send(conf)
})

router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});
```

```shell
# public/index.html文件:
<html>

<head>
  <title>Express</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script src="https://cdn.bootcss.com/axios/0.19.2/axios.min.js"></script>
</head>

<body>
  <h1>Express</h1>
  <p>Welcome to Express</p>
</body>
<script>
  let url = encodeURIComponent(location.href.split('#')[0])
  axios.get('http://localhost:3000/jsapi?url='+url).then((result) => {
    wx.config({
      debug: true,
      appId: '',
      timestamp: '',
      nonceStr: '',
      signature: '',
      jsApiList: []
    })
  })
</script>
</html>
```

## 3-6 完善jsapi鉴权接口并进行本地测试

* 浏览器输入:http://localhost:3000 浏览返回信息

## 3-7 鉴权接口在线部署并使用微信开发者工具进行测试

*  public/index.html文件改写添加vue内容:

```shell
# public/index.html文件改写添加vue内容:
<html>

<head>
  <title>Express</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script src="https://cdn.bootcss.com/axios/0.19.2/axios.min.js"></script>
  <script src="https://cdn.bootcss.com/vue/2.6.11/vue.min.js"></script>
</head>

<body>
  <div id="app">
    <h1>Express</h1>
    <p @click="scanCode">扫描二维码</p>
  </div>
</body>
<script>
  

  new Vue({
    el: '#app',
    mounted() {
      this.wxconfig()
    },
    methods: {
      wxconfig() {
        let url = encodeURIComponent(location.href.split('#')[0])
        axios.get('http://localhost:3000/jsapi?url='+url).then((result) => {
          let {appid, timestamp, noncestr, signature} =  result.data
          console.log(result.data);
          wx.config({
            debug: true,
            appId: appid,
            timestamp,
            nonceStr: noncestr,
            signature,
            jsApiList: [
              'scanQRCode'
            ]
          })
        })
      },
      scanCode(){
        wx.scanQRCode({
          needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
          scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
          success: function (res) {
            var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
            console.log(result);
          }
        });
      }
    }
  })
</script>
</html>

```

* git push到新浪云服务器

```shell
git add .
git commit -m 'jsapi在线部署'
git push
```

* 打开微信开发者工具,地址栏输入网址

## 3-8 js-sdk鉴权报错排查技巧

* sign.js文件sign函数返回的obj追加一个appid属性

## 3-9 云端数据库启动和连接

